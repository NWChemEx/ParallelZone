<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Designing RuntimeView Class &mdash; parallelzone  documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/tabs.css?v=a5c4661c" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=5929fcd5"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Designing ParallelZone’s ResourceSet Class" href="resource_set.html" />
    <link rel="prev" title="Designing ParallelZone’s Parallel Runtime" href="parallel_runtime.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            parallelzone
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../background/index.html">ParallelZone Background</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installing ParallelZone</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/index.html">ParallelZone User Documentation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Developer Documentation</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Design Documentation</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="index.html#high-level-design">High-Level Design</a></li>
<li class="toctree-l3 current"><a class="reference internal" href="index.html#parallel-runtime-design">Parallel Runtime Design</a><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="parallel_runtime.html">Designing ParallelZone’s Parallel Runtime</a></li>
<li class="toctree-l4 current"><a class="current reference internal" href="#">Designing RuntimeView Class</a></li>
<li class="toctree-l4"><a class="reference internal" href="resource_set.html">Designing ParallelZone’s ResourceSet Class</a></li>
<li class="toctree-l4"><a class="reference internal" href="ram.html">Designing RAM Class</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#mpi-helpers">MPI Helpers</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="index.html#utilities-design">Utilities Design</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../initialize_finalize.html">Understanding Runtime Initialization/Finalization</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">parallelzone</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Developer Documentation</a></li>
          <li class="breadcrumb-item"><a href="index.html">Design Documentation</a></li>
      <li class="breadcrumb-item active">Designing RuntimeView Class</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/developer/design/runtime_view.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="designing-runtimeview-class">
<span id="runtime-view-design"></span><h1>Designing RuntimeView Class<a class="headerlink" href="#designing-runtimeview-class" title="Link to this heading"></a></h1>
<p>The need for the <code class="docutils literal notranslate"><span class="pre">RuntimeView</span></code> class grew out of
<a class="reference internal" href="parallel_runtime.html#parallel-runtime-design"><span class="std std-ref">Designing ParallelZone’s Parallel Runtime</span></a>. Here we flesh the design out more.</p>
<section id="why-do-we-need-the-runtimeview-class">
<h2>Why Do We Need the RuntimeView Class?<a class="headerlink" href="#why-do-we-need-the-runtimeview-class" title="Link to this heading"></a></h2>
<p>As discussed in <a class="reference internal" href="parallel_runtime.html#parallel-runtime-design"><span class="std std-ref">Designing ParallelZone’s Parallel Runtime</span></a>, the <code class="docutils literal notranslate"><span class="pre">RuntimeView</span></code> class is
ParallelZone’s abstraction for modeling the runtime environment. <code class="docutils literal notranslate"><span class="pre">RuntimeView</span></code>
will also serve as the top-level <a class="reference internal" href="../../background/abbreviations.html#api"><span class="std std-ref">API</span></a> for accessing ParallelZone
functionality.</p>
</section>
<section id="what-should-the-runtimeview-class-manage">
<h2>What Should the RuntimeView Class Manage?<a class="headerlink" href="#what-should-the-runtimeview-class-manage" title="Link to this heading"></a></h2>
<p>ParallelZone assumes it is managing the runtime environment for a potentially
multi-process program. In general that program can be running on a laptop, the
number one supercomputer in the world, or anything in between.</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">RuntimeView</span></code> is a view of the runtime environment at the highest level.
System-wide state will be accessible from <code class="docutils literal notranslate"><span class="pre">RuntimeView</span></code>. State includes:</p>
<ul class="simple">
<li><p>System-wide scheduling</p></li>
<li><p>System-wide printing</p></li>
<li><p>Processes</p></li>
<li><p>Hardware</p></li>
</ul>
</li>
<li><p>Multi-process operations need to go through <code class="docutils literal notranslate"><span class="pre">RuntimeView</span></code>.</p></li>
<li><p>MPI compatibility.</p></li>
<li><p>Flexibility of backend.</p></li>
<li><p>Setup/teardown of parallel resources</p>
<ul class="simple">
<li><p>See <a class="reference internal" href="../initialize_finalize.html#understanding-runtime-initialization-finalization"><span class="std std-ref">Understanding Runtime Initialization/Finalization</span></a> for more
details, but basically we need callbacks.</p></li>
</ul>
</li>
</ol>
</section>
<section id="runtimeview-architecture">
<h2>RuntimeView Architecture<a class="headerlink" href="#runtimeview-architecture" title="Link to this heading"></a></h2>
<figure class="align-center" id="id1">
<span id="fig-runtime-view"></span><img alt="../../_images/runtime_view.png" src="../../_images/runtime_view.png" />
<figcaption>
<p><span class="caption-number">Fig. 7 </span><span class="caption-text">Schematic illustration of the RuntimeView class and its major pieces.</span><a class="headerlink" href="#id1" title="Link to this image"></a></p>
</figcaption>
</figure>
<p>The architecture of <code class="docutils literal notranslate"><span class="pre">RuntimeView</span></code> is shown in <a class="reference internal" href="#fig-runtime-view"><span class="std std-numref">Fig. 7</span></a>. This
addresses the above consideration by (numbering is from above):</p>
<ol class="arabic simple">
<li><p>Introducing components for each piece of state. Process to component affinity
is maintained by <code class="docutils literal notranslate"><span class="pre">ResourceSet</span></code> objects.</p></li>
<li><p>Exposing MPI All-to-All operations at the <code class="docutils literal notranslate"><span class="pre">RuntimeView</span></code> level.</p>
<ul class="simple">
<li><p>MPI All-to-One and One-to-All Operations are delegated to <code class="docutils literal notranslate"><span class="pre">RAM</span></code> and
<code class="docutils literal notranslate"><span class="pre">GPU</span></code> objects in a particular <code class="docutils literal notranslate"><span class="pre">ResourceSet</span></code>.</p></li>
<li><p>This facilitates selecting start/end points.</p></li>
</ul>
</li>
<li><p>MPI support happens via the <code class="docutils literal notranslate"><span class="pre">CommPP</span></code> class.</p></li>
<li><p>The use of the PIMPL design allows us to hide many of the backend types. It
also facilitates writing an implementation for a different backend down the
line (although the API would need to change too).</p></li>
<li><p>Storing of callbacks allows us to tie the lifetime of the <code class="docutils literal notranslate"><span class="pre">RuntimeView</span></code> to
the teardown of parallel resources, i.e., <code class="docutils literal notranslate"><span class="pre">RuntimeView</span></code> will automatically
finalize any parallel resources which depend on <code class="docutils literal notranslate"><span class="pre">RuntimeView</span></code> before
finalizing itself.</p>
<ul class="simple">
<li><p>Note, finalization callbacks are stored in a stack to ensure a controlled
teardown order as is usually needed for libraries with initialize/finalize
functions.</p></li>
</ul>
</li>
</ol>
<p>Some finer points:</p>
<ul class="simple">
<li><p>The scheduler is envisioned as taking task graphs and scheduling them in a
distributed and threaded manner. The latter relies on collaboration with
<code class="docutils literal notranslate"><span class="pre">ResourceSet</span></code> instances.</p></li>
<li><p>The Logger is an instance that every process can access. It represents the
authoritative printing of the program. It’s exact behavior should be
customizable, but it is assumed this logger is always called in a SIMD manner
by all processes. Default behavior is to redirect all output to <code class="docutils literal notranslate"><span class="pre">/dev/null</span></code>
except that of the root process.</p></li>
</ul>
</section>
<section id="proposed-apis">
<h2>Proposed APIs<a class="headerlink" href="#proposed-apis" title="Link to this heading"></a></h2>
<p>Examples of all-to-all communications:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span><span class="w"> </span><span class="n">rt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_runtime</span><span class="p">();</span>

<span class="k">auto</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generate_data</span><span class="p">();</span>

<span class="c1">// This is an all gather</span>
<span class="k">auto</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rt</span><span class="p">.</span><span class="n">gather</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

<span class="c1">// This is an all reduce</span>
<span class="k">auto</span><span class="w"> </span><span class="n">output2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rt</span><span class="p">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">op</span><span class="p">);</span>
</pre></div>
</div>
<p>Example of tying another library’s parallel runtime teardown to the lifetime of
a <code class="docutils literal notranslate"><span class="pre">RuntimeView</span></code> (note this is only relevant when ParallelZone starts MPI):</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="c1">// Create a RuntimeView object</span>
<span class="n">RuntimeView</span><span class="w"> </span><span class="n">rt</span><span class="p">;</span>

<span class="c1">// Initialize the other library</span>
<span class="n">other_library_initialize</span><span class="p">();</span>

<span class="c1">// Register the corresponding finalization routine with the RuntimeView</span>
<span class="n">rt</span><span class="p">.</span><span class="n">stack_callback</span><span class="p">(</span><span class="n">other_library_finalize</span><span class="p">);</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>As written the APIs assume the data is going to/from RAM. If we eventually
want to support other memory spaces we could create overloads which take the
target space. In particular we note that we can NOT do things like:</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">auto</span><span class="w"> </span><span class="n">output</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rt</span><span class="p">.</span><span class="n">my_resource_set</span><span class="p">().</span><span class="n">ram</span><span class="p">().</span><span class="n">gather</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
</pre></div>
</div>
<p>because that would result in deadlock (it calls a series of all-to-one calls
where each rank thinks it’s the root).</p>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="parallel_runtime.html" class="btn btn-neutral float-left" title="Designing ParallelZone’s Parallel Runtime" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="resource_set.html" class="btn btn-neutral float-right" title="Designing ParallelZone’s ResourceSet Class" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, NWChemEx Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>